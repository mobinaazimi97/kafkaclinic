<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <title data-i18n="schedules_title">برنامه‌های خالی</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/style.css" />

    <script src="js/main.js"></script>

</head>
<body>
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center">
        <h1 data-i18n="schedules_title">برنامه‌های خالی</h1>
        <div>
            <button class="btn btn-outline-primary btn-sm" onclick="setLanguage('fa')">FA</button>
            <button class="btn btn-outline-secondary btn-sm" onclick="setLanguage('en')">EN</button>
        </div>
    </div>
    <div id="schedule-list" class="mt-3"></div>

    <hr />

    <div id="booking-form" style="display:none;">
        <h3 data-i18n="book_appointment">رزرو نوبت</h3>
        <form id="appointment-form">
            <div class="mb-3">
                <label for="patientId" class="form-label" data-i18n="patient_id">شناسه بیمار</label>
                <input type="text" id="patientId" name="patientId" class="form-control" required />
            </div>
            <div class="mb-3">
                <label for="notes" class="form-label" data-i18n="notes">یادداشت</label>
                <textarea id="notes" name="notes" class="form-control" rows="3"></textarea>
            </div>
            <input type="hidden" id="selectedScheduleId" name="scheduleId" />
            <button type="submit" class="btn btn-success" data-i18n="confirm_booking">تایید رزرو</button>
            <button type="button" class="btn btn-secondary" data-i18n="cancel" onclick="hideBookingForm()">لغو</button>
        </form>
        <div id="booking-message" class="mt-3"></div>
    </div>

    <a href="index.html" class="btn btn-link mt-4" data-i18n="back_to_specializations">بازگشت به انتخاب تخصص</a>
</div>

<script src="js/translations.js"></script>
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const specId = urlParams.get('specId');

    const scheduleList = document.getElementById('schedule-list');
    const bookingForm = document.getElementById('booking-form');
    const appointmentForm = document.getElementById('appointment-form');
    const bookingMessage = document.getElementById('booking-message');
    const selectedScheduleIdInput = document.getElementById('selectedScheduleId');

    let selectedScheduleId = null;

    function formatDateTime(dateTimeStr) {
        const lang = currentLang;
        const dt = new Date(dateTimeStr);
        if (lang === 'fa') {
            // ساده‌ترین حالت: فقط تاریخ میلادی، می‌تونی بعدا تقویم فارسی اضافه کنی
            return dt.toLocaleDateString('fa-IR') + ' ' + dt.toLocaleTimeString('fa-IR', {hour: '2-digit', minute:'2-digit'});
        } else {
            return dt.toLocaleString('en-US', {dateStyle: 'medium', timeStyle: 'short'});
        }
    }

    function loadSchedules() {
        fetch(`/appointments/specializations/${specId}`)
            .then(res => res.json())
            .then(data => {
                scheduleList.innerHTML = '';
                if (data.length === 0) {
                    scheduleList.innerHTML = `<p data-i18n="no_schedules">هیچ برنامه خالی‌ای وجود ندارد.</p>`;
                    applyTranslations();
                    return;
                }
                data.forEach(sch => {
                    const btnClass = sch.isBooked ? 'btn-secondary disabled' : 'btn-primary';
                    const card = document.createElement('div');
                    card.className = 'card mb-2 shadow-sm';
                    card.innerHTML = `
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h5>${formatDateTime(sch.startDateTime)} - ${formatDateTime(sch.endDateTime)}</h5>
                            <p><strong>${sch.doctorFirstName} ${sch.doctorLastName}</strong></p>
                        </div>
                        <button class="btn ${btnClass}" ${sch.isBooked ? 'disabled' : ''} onclick="showBookingForm('${sch.scheduleUuid}')"
                            data-i18n="${sch.isBooked ? 'booked' : 'book'}">
                            ${sch.isBooked ? (currentLang === 'fa' ? 'رزرو شده' : 'Booked') : (currentLang === 'fa' ? 'رزرو' : 'Book')}
                        </button>
                    </div>
                `;
                    scheduleList.appendChild(card);
                });
                applyTranslations();
            });
    }

    function showBookingForm(scheduleId) {
        selectedScheduleId = scheduleId;
        selectedScheduleIdInput.value = scheduleId;
        bookingForm.style.display = 'block';
        bookingMessage.innerText = '';
    }

    function hideBookingForm() {
        bookingForm.style.display = 'none';
        appointmentForm.reset();
        bookingMessage.innerText = '';
    }

    appointmentForm.addEventListener('submit', e => {
        e.preventDefault();
        const patientId = appointmentForm.patientId.value.trim();
        const notes = appointmentForm.notes.value.trim();

        if (!selectedScheduleId) {
            bookingMessage.innerText = currentLang === 'fa' ? 'لطفا یک برنامه را انتخاب کنید.' : 'Please select a schedule.';
            return;
        }

        const payload = {
            scheduleId: selectedScheduleId,
            patientId: patientId,
            notes: notes,
            appointmentDateTime: new Date().toISOString() // چون در DTO اجباریه، می‌فرستم تاریخ الان رو (می‌تونی تو بک‌اند اصلاح کنی)
        };

        fetch('/appointments', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(res => {
                if (res.ok) return res.json();
                else return res.text().then(text => Promise.reject(text));
            })
            .then(data => {
                bookingMessage.style.color = 'green';
                bookingMessage.innerText = currentLang === 'fa' ? 'نوبت با موفقیت ثبت شد.' : 'Appointment booked successfully.';
                hideBookingForm();
                loadSchedules();
            })
            .catch(err => {
                bookingMessage.style.color = 'red';
                bookingMessage.innerText = currentLang === 'fa' ? 'خطا در ثبت نوبت: ' + err : 'Booking error: ' + err;
            });
    });

    document.addEventListener('DOMContentLoaded', () => {
        loadSchedules();
        loadTranslations();
    });
</script>
</body>
</html>
